<main>
  <h1>Faça seu Pedido</h1>

  <form id="pedidoForm">
    <input type="text" name="nomes" placeholder="Seu nome" required>

    <select name="produto" id="produto" required></select>

    <input type="number" name="quantidade" id="quantidade" min="1" value="1" required>

    <textarea name="observacao" placeholder="Alguma observação?"></textarea>

    <p id="precoTotal">Preço Total: R$ 0,00</p>

    <button type="submit">Enviar Pedido</button>
  </form>

  <h2>Pedidos Realizados</h2>
  <ul id="listaPedidos"></ul>
</main>

<!-- Coloque o script AQUI -->
<script>
document.addEventListener('DOMContentLoaded', () => {

  let produtos = [];

  async function carregarCardapio() {
    const res = await fetch('/cardapio');
    const dados = await res.json();
    produtos = dados.produtos; // <-- Pega a lista dentro de "produtos"!

    const select = document.getElementById('produto');
    produtos.forEach(p => {
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = `${p.nome} - R$ ${p.preco.toFixed(2)}`;
      select.appendChild(option);
    });
  }

  async function carregarPedidos() {
    const res = await fetch('/pedidos');
    const dados = await res.json();
    const pedidos = dados.pedidos; // <-- Pega a lista dentro de "pedidos"!

    const lista = document.getElementById('listaPedidos');
    lista.innerHTML = '';

    pedidos.forEach(p => {
      const li = document.createElement('li');
      li.textContent = `${p.nomes} pediu ${p.itens} - Total: R$ ${p.total} - Obs: ${p.Observacao}`;
      lista.appendChild(li);
    });
  }

  function calcularPreco() {
    const produtoId = document.getElementById('produto').value;
    const quantidade = parseInt(document.getElementById('quantidade').value);
    const produto = produtos.find(p => p.id == produtoId);

    if (produto) {
      const total = produto.preco * quantidade;
      document.getElementById('precoTotal').textContent = `Preço Total: R$ ${total.toFixed(2)}`;
    } else {
      document.getElementById('precoTotal').textContent = 'Preço Total: R$ 0,00';
    }
  }

  const form = document.getElementById('pedidoForm');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    data.quantidade = parseInt(data.quantidade);

    const produtoSelecionado = produtos.find(p => p.id == Number(data.produto));

    if (!produtoSelecionado) {
      alert('Produto inválido');
      return;
    }

    const pedido = {
      nomes: data.nomes,
      itens: produtoSelecionado.nome,
      total: (produtoSelecionado.preco * data.quantidade).toFixed(2),
      Observacao: data.observacao
    };

    await fetch('/pedidos', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(pedido)
    });

    form.reset();
    calcularPreco();
    carregarPedidos();
  });

  carregarCardapio().then(carregarPedidos);

});
</script>